---
title: IIS 篇
titleTemplate: 环境搭建教程
---

# IIS 下搭建 PHP 环境

IIS 是 Windows 上自带的 Web 服务器，经过多年的打磨(于 1995 年发布)，在功能上做的比较完善。

::: tip 推荐
如果环境部署在 Windows 上，并且对权限安全有更高要求，非常推荐使用 IIS ！
:::

::: tip vc 运行库
PHP、MySQL、Redis、PostgreSQL 都依赖 `vc++运行库`，不同的版本依赖的 `vc++运行库`版本也不一样，这里推荐使用 [[vcredist]](https://github.com/abbodi1406/vcredist) 一键安装
:::

::: tip 终端
下面涉及的终端(`cmd.exe/pwsh.exe`)操作，基本上都需要 `以管理员身份` 打开，如无需使用或不应该 `以管理员身份` 打开的均会做说明。
:::

## 一、权限说明

### 1. Windows 与 Linux 权限上的区别

-   Linux 想要获得 `指定路径文件(或目录)` 的权限，必须确保用户对该文件的所有上级目录具备 `执行(x)` 权限；
-   Windows 想要获得 `指定路径文件(或目录)` 的权限，只需用户对当前文件(或目录)具备对应权限即可，无需考虑上级目录权限问题。

### 2. 创建系统用户/用户组

1. 用户组

    | 用户组名            | 描述                      |
    | ------------------- | ------------------------- |
    | `IIS_AppPool_Users` | IIS 应用池用户组          |
    | `PHP_CGI_Users`     | 多版本 PHP CGI 通用用户组 |

    ::: warning 可以更安全
    你可以在 `PHP_CGI_Users` 用户组存在的情况下，再为每个版本的 PHP CGI 单独创建用户组，如：

    | PHP CGI 用户组名 | 描述                      |
    | ---------------- | ------------------------- |
    | PHP_CGI_Users    | 多版本 PHP CGI 通用用户组 |
    | PHP84_CGI_Users  | PHP8.4 CGI 用户组         |
    | PHP74_CGI_Users  | PHP7.4 CGI 用户组         |

    :::

2. IIS 站点用户

    | IIS 站点用户 | 描述               |
    | ------------ | ------------------ |
    | `www`        | IIS 站点用户[通用] |

    ::: warning 可以更安全
    你可以为每个站点单独创建用户，如：

    | 站点用户名  | 描述              |
    | ----------- | ----------------- |
    | www_tp      | ThinkPHP 站点用户 |
    | www_fastphp | FastPHP 站点用户  |
    | www_static  | 静态站点用户      |

    :::

3. IIS 应用池用户

    | IIS 应用池用户 | 描述                         | 归属用户组                                            |
    | -------------- | ---------------------------- | ----------------------------------------------------- |
    | `iis`          | IIS 应用池用户[默认]         | `IIS_AppPool_Users`                                   |
    | `iis_php74`    | IIS 应用池用户[支持 PHP CGI] | `IIS_AppPool_Users` `PHP_CGI_Users` `PHP74_CGI_Users` |
    | `iis_php84`    | IIS 应用池用户[支持 PHP CGI] | `IIS_AppPool_Users` `PHP_CGI_Users` `PHP84_CGI_Users` |

::: details 截图
![创建用户和用户组](./assets/iis/create-user-and-group.gif)
:::

## 二、PHP 解释器

案例使用了 2 个 PHP 版本的解释器：

1. PHP 8.4.7
2. PHP 7.4.33

### 1. 目录结构

::: details 安装目录如下：

```
├─ C:\php ==================================================== [PHP 安装根目录]
|   ├─ 74 ------------------------------------------ PHP 7.4.x 解释器根目录
|   |  ├─ ext -------------------- PHP 扩展存放路径
|   |  ├─ composer.bat ----------- Composer 执行脚本
|   |  ├─ php-cs-fixer.bat ------- php-cs-fixer 执行脚本
|   |  ├─ php.ini ---------------- php 配置文件
|   |  ├─ php.exe ---------------- 用于命令行的执行文件
|   |  ├─ php-cgi.exe ------------ 用于 CGI 的执行文件
|   |  ├─ phpdbg.exe ------------- PHP的SAPI模块(是个调试工具)
|   |  ├─ php-win.exe ------------ 用于命令行的执行文件(不显示输出内容)
|   |  └─ ...
|   |
|   ├─ 84 ------------------------------------------ PHP 8.4.x 解释器根目录
|   |  ├─ ext -------------------- PHP 扩展存放路径
|   |  ├─ composer.bat ----------- Composer 执行脚本
|   |  ├─ php-cs-fixer.bat ------- php-cs-fixer 执行脚本
|   |  ├─ php.ini ---------------- php 配置文件
|   |  ├─ php.exe ---------------- 用于命令行的执行文件
|   |  ├─ php-cgi.exe ------------ 用于 CGI 的执行文件
|   |  ├─ phpdbg.exe ------------- PHP的SAPI模块(是个调试工具)
|   |  ├─ php-win.exe ------------ 用于命令行的执行文件(不显示输出内容)
|   |  └─ ...
|   |
|   ├─ config --------------------------------------- PHP 多版本通用配置存放路径
|   |  ├─ cacert.pem ------------- Curl 和 OpenSSL 扩展的证书文件
|   |  └─ ...
|   |
|   ├─ tools ---------------------------------------- PHP 多版本通用工具存放路径
|   |  ├─ composer.phar ---------- Composer 包
|   |  ├─ php-cs-fixer-v3.phar --- PHP CS Fixer 包
|   |  └─ ...
|   └─
└─
```

:::

### 2. 配置权限 {#php-authorization}

::: tip 基本权限与高级权限对应关系

| 基本权限         | 高级权限                                                            |
| ---------------- | ------------------------------------------------------------------- |
| `读取`           | `列出文件夹/读取数据`+`读取属性`+`读取扩展属性`+`读取权限`          |
| `列出文件夹内容` | `遍历文件夹/执行文件`                                               |
| `写入`           | `创建文件/写入数据`+`创建文件夹/附加数据`+`写入属性`+`写入扩展属性` |
| `读取和执行`     | 基本权限-`读取`+`列出文件夹内容`                                    |
| `修改`           | 基本权限-`读取`+`列出文件夹内容`+`写入`                             |

:::

| 路径            | 授权用户          | 授予权限              |
| --------------- | ----------------- | --------------------- |
| `C:\php\74`     | `PHP74_CGI_Users` | 基本权限-`读取和执行` |
| `C:\php\84`     | `PHP84_CGI_Users` | 基本权限-`读取和执行` |
| `C:\php\config` | `PHP_CGI_Users`   | 基本权限-`读取和执行` |
| `C:\php\tools`  | `PHP_CGI_Users`   | 基本权限-`读取和执行` |

::: details 截图
![php安装包授权示意图](/assets/iis/php-authorization.gif)
:::

## 三、安装 IIS

针对 PHP CGI 我们至少需要启用以下功能：

### 1. 启用功能

-   资源管理器进入 `控制面板\程序\程序和功能`；
-   点击左侧的 `启用或关闭 Windows 功能`；
-   启用的功能请查看下面的截图或文字：

::: details 截图
![Windows上启用IIS功能](/assets/iis/control-panel.png)
![Windows上启用IIS功能](/assets/iis/enable-iis.png)
:::

::: details 文字

```
====================================================
启用或关闭 Windows 功能
====================================================
├─ Internet Information Services
|   ├─ Web 管理工具
|   |  ├─ IIS 管理服务
|   |  ├─ IIS 管理脚本和工具
|   |  ├─ IIS 管理控制台
|   |  └─ ...
|   |
|   ├─ 万维网服务
|   |  ├─ 常见 HTTP 功能
|   |  |  ├─ 静态内容
|   |  |  ├─ 默认文档
|   |  |  └─ ...
|   |
|   ├─ 应用程序开发功能
|   |  ├─ CGI
|   |  └─ ...
|   |
|
```

:::

### 2. 安装 URL 重写模块

-   进入 [`[官方介绍链接]`](https://www.iis.net/downloads/microsoft/url-rewrite) 并滚动到底部；
-   点击 `Chinese Simplified:` 行的 `x64 installer` 进行下载；

    ::: details 截图
    ![下载url重写模块](/assets/iis/url-rewrite.png)
    :::

-   双击 `rewrite_amd64_zh-CN.msi` 安装。

### 3. 配置默认文档

新增 index.php 作为默认文档，支持 `全局新增` 和 `站点单独新增`，案例使用了全局新增

::: details 截图
![全局新增默认文档](./assets/iis/add-default-ducment.gif)
:::

### 4. 新增应用池

| 应用池  | 标识用户       | 描述                                                 |
| ------- | -------------- | ---------------------------------------------------- |
| default | `iis` 或 `www` | 静态站点使用，无需授予其他特殊权限                   |
| php74   | iis_php74      | php7.4 站点使用，需授予 php7.4 CGI 应用程序相关权限  |
| php84   | iis_php84      | php78.4 站点使用，需授予 php8.4 CGI 应用程序相关权限 |

::: details 截图
![新增应用池](./assets/iis/create-iis-app-pool.gif)
:::

### 5. FastCGI 设置

| php 版本 | 路径                  |
| -------- | --------------------- |
| php 7.4  | C:\php\74\php-cgi.exe |
| php 8.4  | C:\php\84\php-cgi.exe |

::: details 截图
![设置fastcgi](./assets/iis/set-fastcgi.gif)
:::

### 6. `应用池/站点/模块` 关联

`站点` 是容器，通过绑定访问；`应用池` 承载应用，管理其进程与资源；`模块` 实现具体功能，如 FastCGI、身份验证等功能。

-   `站点-用户` 需要能访问站点根目录及其子目录；
-   `应用池-标识用户`:
    1. 通常需要能访问项目根目录及其子目录；
    2. 对于需要修改或写入的目录，还需要具有写入权限；
    3. 需其他应用程序支持的模块(如: `FastCgiModule` 等)，还需要对应程序的相关授权，如：[[php 授权]](#php-authorization)。

### 7. 处理程序映射 — FastCGI 模块

添加 FastCGI 模块统一支持 `全局添加` 和 `站点单独添加` 两种方式，

我们不推荐全局添加 FastCGI 模块，本次案例也是在创建站点时单独添加 FastCGI 模块，

详情请阅读 [[站点应用案例-处理程序映射截图]](#handler-mapping)

## 四、站点应用案例 {#site-app-case}

::: details 统一截图
![创建站点案例](./assets/iis/create-sites.gif)

::: warning 注意：
在 gif 里 tp 的项目根目录授予用户 `iis_php84/iis_php74` 的权限是 `基本权限-读取和执行`，

事实上最低权限通常只需要 `基本权限-读取`
:::

::: details 处理程序映射截图 {#handler-mapping}
![创建站点案例](./assets/iis/handler-mapping.gif)
:::

### 1. 静态站点

| 用户授权 | 目录范围           | 授予权限        |
| -------- | ------------------ | --------------- |
| `www`    | 站点根目录及子目录 | `基本权限-读取` |

| 关键词   | 选中值    |
| -------- | --------- |
| 站点用户 | `www`     |
| 应用池   | `default` |

::: details 目录结构

```[项目目录结构]
├─ D:\www\doc.php.io ========================================== [项目根目录]
|   ├─ php-chunked-xhtml ------------------- 主要子目录
|   ├─ web.config -------------------------- 站点伪静态
|   └─ ...
└─
```

:::

### 2. ThinkPHP 项目

| 用户授权              | 目录范围                          | 授予权限        |
| --------------------- | --------------------------------- | --------------- |
| `iis_php84/iis_php74` | 项目根目录及子目录                | `基本权限-读取` |
| `iis_php84/iis_php74` | 上传目录 `/public/static/uploads` | `基本权限-修改` |
| `iis_php84/iis_php74` | 运行时目录 `/runtime`             | `基本权限-修改` |
| `www`                 | 站点根目录 `/public` 及其子目录   | `基本权限-读取` |

::: details 目录结构

```[项目目录结构]
├─ D:\www\(tp8|tp6) =============================================== [项目根目录]
|   ├─ public ---------------------------------- 站点伪静态
|   |  ├─ static ------------------------- 静态资源目录
|   |  ├─  ├─ uploads ---------- 上传目录
|   |  ├─  ├─ ...
|   |  ├─
|   |  ├─ web.config --------------------- 站点伪静态
|   |  ├─ favicon.ico -------------------- 网站 ico 图标
|   |  ├─ ...
|   |
|   ├─ runtime ---------------------------------- 站点伪静态
|   ├─ ...
|   |
└─
```

:::

1. ThinkPHP 8.1

    | 关键词             | 选中值                     |
    | ------------------ | -------------------------- |
    | 站点用户           | `www`                      |
    | 应用池             | `php84`                    |
    | FastCgiModule 模块 | php 8.4 提供的 php-cgi.exe |

2. ThinkPHP 6.1

    | 关键词             | 选中值                     |
    | ------------------ | -------------------------- |
    | 站点用户           | `www`                      |
    | 应用池             | `php74`                    |
    | FastCgiModule 模块 | php 7.4 提供的 php-cgi.exe |

## 五、伪静态案例

::: code-group

<<< @/assets/iis/php-doc/web.config{xml} [[doc.php.io]]
<<< @/assets/iis/tp/web.config{xml} [[ThinkPHP]]

:::

<!--@include: ./msdn/mysql.md-->
<!--@include: ./msdn/redis.md-->
<!--@include: ./msdn/pgsql.md-->
